# SCNAI植鉴系统 - 植物图鉴前端接口实现文档
## 植物接口实现
**文件**: `frontend/src/services/plant.js`
```javascript
export const plantService = {
  /**
   * 获取所有植物列表
   */
  async getAllPlants() {
    try {
      const response = await api.get('/plants')
      return response.data
    } catch (error) {
      console.error('获取植物列表失败:', error)
      throw error
    }
  },

  /**
   * 根据ID获取植物详情
   * @param {number} id 植物ID
   */
  async getPlantById(id) {
    try {
      const response = await api.get(`/plants/${id}`)
      return response.data
    } catch (error) {
      console.error('获取植物详情失败:', error)
      throw error
    }
  },

  /**
   * 模糊搜索植物
   * @param {string} keyword 搜索关键词
   */
  async searchPlants(keyword) {
    try {
      const response = await api.get('/plants/search/keyword', {
        params: { keyword }
      })
      return response.data
    } catch (error) {
      console.error('搜索植物失败:', error)
      throw error
    }
  },

  /**
   * 根据名称精确查询植物
   * @param {string} name 植物名称
   */
  async searchPlantByName(name) {
    try {
      const response = await api.get('/plants/search', {
        params: { name }
      })
      return response.data
    } catch (error) {
      console.error('按名称查询植物失败:', error)
      throw error
    }
  }
}
```

### 接口对应关系

| 前端方法 | 后端接口 | 功能 |
|---------|----------|------|
| `getAllPlants()` | `GET /api/plants` | 获取所有植物列表 |
| `getPlantById(id)` | `GET /api/plants/{id}` | 获取植物详情 |
| `searchPlants(keyword)` | `GET /api/plants/search/keyword?keyword=xxx` | 模糊搜索植物 |
| `searchPlantByName(name)` | `GET /api/plants/search?name=xxx` | 精确查询植物 |
```

---

## 三、组件接口调用

### Atlas.vue (植物列表页)

**核心接口调用**:

```javascript
// 加载数据
const loadData = async () => {
  try {
    loading.value = true
    const response = await plantService.getAllPlants()
    if (response.success) {
      allPlants.value = response.data || []
      plants.value = [...allPlants.value]
    } else {
      ElMessage.error(response.error || '获取植物数据失败')
    }
  } catch (error) {
    console.error('加载植物数据失败:', error)
    ElMessage.error('加载植物数据失败，请稍后重试')
  } finally {
    loading.value = false
  }
}

// 搜索功能 (包含空查询处理)
const handleSearch = async () => {
  const query = searchQuery.value.trim()
  if (!query) {
    plants.value = [...allPlants.value]
    return
  }

  try {
    loading.value = true
    const response = await plantService.searchPlants(query)
    if (response.success) {
      plants.value = response.data || []
    } else {
      ElMessage.error(response.error || '搜索失败')
    }
  } catch (error) {
    console.error('搜索失败:', error)
    ElMessage.error('搜索失败，请稍后重试')
  } finally {
    loading.value = false
  }
}

// 点击详情跳转
const viewDetail = (plant) => {
  router.push(`/plant/${plant.id}`)
}
```

### PlantDetail.vue (植物详情页)

**核心接口调用**:

```javascript
// 获取详情 (包含参数验证和错误处理)
const loadPlantDetail = async () => {
  const plantId = route.params.id
  if (!plantId) {
    error.value = '无效的植物ID'
    loading.value = false
    return
  }

  try {
    loading.value = true
    error.value = ''
    const response = await plantService.getPlantById(plantId)
    if (response.success) {
      plant.value = response.data
    } else {
      error.value = response.error || '获取植物详情失败'
      ElMessage.error(error.value)
    }
  } catch (err) {
    error.value = '网络错误，请稍后重试'
    console.error('获取植物详情失败:', err)
    ElMessage.error('获取植物详情失败，请稍后重试')
  } finally {
    loading.value = false
  }
}
```

---

## 四、数据流转说明

1. **数据获取**: `Atlas.vue` → `plantService.getAllPlants()` → 后端 `/api/plants`
2. **搜索功能**: 输入框 → 防抖处理(300ms) → `plantService.searchPlants()` → 后端搜索API
3. **详情查看**: 点击卡片 → 路由跳转 → `PlantDetail.vue` → `plantService.getPlantById()`

---

### 4.2 PlantDetail.vue (植物详情页)

#### 4.2.1 文件位置
`frontend/src/views/PlantDetail.vue`

#### 4.2.2 接口调用实现

```javascript
// 导入服务
import { plantService } from '@/services/plant'
import { useRoute } from 'vue-router'

export default {
  setup() {
    const route = useRoute()
    const plant = ref(null)
    const loading = ref(true)
    const error = ref('')

    // 获取路由参数中的植物ID
    const loadPlantDetail = async () => {
      const plantId = route.params.id

      if (!plantId) {
        error.value = '无效的植物ID'
        loading.value = false
        return
      }

      try {
        loading.value = true
        error.value = ''

        const response = await plantService.getPlantById(plantId)

        if (response.success) {
          plant.value = response.data
        } else {
          error.value = response.error || '获取植物详情失败'
          ElMessage.error(error.value)
        }
      } catch (err) {
        error.value = '网络错误，请稍后重试'
        console.error('获取植物详情失败:', err)
        ElMessage.error('获取植物详情失败，请稍后重试')
      } finally {
        loading.value = false
      }
    }

    // 计算属性：解析JSON格式的病害数据
    const parsedDiseases = computed(() => {
      if (!plant.value?.commonDiseases) return null
      try {
        return JSON.parse(plant.value.commonDiseases)
      } catch {
        return null
      }
    })

    onMounted(loadPlantDetail)

    return {
      plant,
      loading,
      error,
      parsedDiseases,
      loadPlantDetail
    }
  }
}
```

#### 4.2.3 数据展示逻辑

1. **参数获取**: 从路由参数 `/:id` 获取植物ID
2. **数据加载**: 调用 `getPlantById(id)` 获取详情
3. **JSON解析**: 自动解析 `commonDiseases` 字段的JSON数据
4. **错误处理**: 完善的加载和错误状态

---

## 八、状态管理

### 8.1 Pinia Store配置

#### 8.1.1 Auth Store (`stores/auth.js`)

```javascript
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', () => {
  const token = ref(localStorage.getItem('token') || null)
  const user = ref(null)
  const isAuthenticated = computed(() => !!token.value)

  const login = async (loginData) => {
    // 调用认证API
    const response = await authService.login(loginData)

    if (response.success) {
      token.value = response.data.token
      user.value = response.data.user
      localStorage.setItem('token', token.value)
    }

    return response
  }

  const logout = () => {
    token.value = null
    user.value = null
    localStorage.removeItem('token')
  }

  return {
    token,
    user,
    isAuthenticated,
    login,
    logout
  }
})
```
### 8.2 组件中使用Store

```javascript
// 在组件中
import { useAuthStore } from '@/stores/auth'

export default {
  setup() {
    const authStore = useAuthStore()
    const user = computed(() => authStore.user)

    return { user }
  }
}
```
