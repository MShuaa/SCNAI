import{_ as K,c as d,a as D,b as e,r as L,t as w,h as T,F as H,l as N,i as P,v as I,m as z,f as k,x as A,g as u,n as V,d as E}from"./index-BlU5efSE.js";import{P as j}from"./logo-BtVPCAG9.js";import{S as O}from"./Sidebar-C2eUXXSZ.js";import{b as F,u as J}from"./auth-Bm6ta8Sy.js";const R={async sendMessage(y){return(await F.post("/chat",{message:y})).data},async sendMessageStream(y,s,a,o){try{const m={Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"},p=await fetch("/api/chat/stream",{method:"POST",headers:m,body:JSON.stringify({message:y})});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const _=p.body.getReader(),c=new TextDecoder;let h="",n="";for(;;){const{done:f,value:C}=await _.read();if(f)break;h+=c.decode(C,{stream:!0});const x=h.split(`
`);h=x.pop()||"";for(const S of x)if(S.trim()!==""&&S.startsWith("data:")){const i=S.slice(5).trim();if(i)try{const t=JSON.parse(i);t.type==="start"?n="":t.type==="chunk"&&s?(n+=t.content,s(t.content)):t.type==="complete"&&a?a(t.content||n):t.type==="error"&&o&&o(t.error)}catch(t){console.error("解析流式数据错误:",t,"原始数据:",i)}}}}catch(g){throw console.error("sendMessageStream错误:",g),o&&o(g.message),g}}},U={name:"Chat",components:{ParticlesBackground:j,Sidebar:O},setup(){const y=J(),s=z(()=>y.user),a=k([]),o=k(""),g=k(!1),m=k(!1),p=k(null),_=k(["丝瓜白粉病的症状和防治方法","如何预防植物病虫害？","植物叶片发黄是什么原因？","有机农业病虫害防治技巧"]),c=()=>{A(()=>{p.value&&(p.value.scrollTop=p.value.scrollHeight)})},h=(i,t="sent")=>{const r=new Date;a.value.push({content:i,type:t,time:r.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}),c()},n=async()=>{const i=o.value.trim();if(!i||g.value)return;h(i,"sent"),o.value="",g.value=!0,m.value=!0;const t=a.value.length;a.value.push({content:"",type:"received",time:new Date().toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),isStreaming:!0}),c();try{await R.sendMessageStream(i,r=>{a.value[t]&&(a.value[t].content+=r,c())},r=>{a.value[t]&&(a.value[t].content=r,a.value[t].isStreaming=!1,m.value=!1,c())},r=>{console.error("流式消息错误:",r),a.value[t]&&(a.value[t].content="抱歉，我无法回答这个问题。",a.value[t].isStreaming=!1,m.value=!1,c())})}catch(r){console.error("发送消息错误:",r),a.value[t]&&(a.value[t].content="发送失败，请稍后重试。",a.value[t].isStreaming=!1,m.value=!1,c())}finally{g.value=!1}};return{user:s,messages:a,inputMessage:o,sending:g,typing:m,messagesContainer:p,suggestions:_,sendMessage:n,handleKeyDown:i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),n())},selectSuggestion:i=>{o.value=i},formatMessageContent:i=>{let t=i;if(/^\d+\.\s/.test(i)||/\n\d+\.\s/.test(i)){const r=[];let M=i;const v=/\n*\s*(\d+)\.\s+([\s\S]*?)(?=\n\s*\d+\.\s|$)/g;let b;for(;(b=v.exec(M))!==null;){let l=b[2].trim();l=`${b[1]}. ${l}`,(/^\d+\.\s*[一二三四五六七八九十百千]+、/.test(l)||/^\d+\.\s*\d+、/.test(l)||/^\d+\.\s*\([一二三四五六七八九十百千1234567890]+\)/.test(l)||/^\d+\.\s*\d+\)/.test(l)||/^\d+\.\s*[标题|小标题].*?[：:]/i.test(l))&&(l=`<span class="content-heading">${l}</span>`),r.push(l)}if(r.length>0){let l='<ul class="message-list">';r.forEach(B=>{B.trim()&&(l+=`<li class="message-list-item">${B.trim()}</li>`)}),l+="</ul>",t=l}else t=`<p>${i}</p>`}else{let r=i.split(`
`);t="",r.forEach(M=>{if(!M.trim())return;let v=M.trim();/^[一二三四五六七八九十百千]+、/.test(v)||/^\d+、/.test(v)||/^\([一二三四五六七八九十百千1234567890]+\)/.test(v)||/^\d+\)/.test(v)||/^[标题|小标题].*?[：:]/i.test(v)?t+=`<p class="content-heading">${v}</p>`:t+=`<p>${v}</p>`})}return t},copyMessage:async(i,t)=>{try{await navigator.clipboard.writeText(i),a.value[t].showTooltip=!0,a.value[t].tooltipText="已复制!",setTimeout(()=>{a.value[t]&&(a.value[t].showTooltip=!1,a.value[t].tooltipText="复制")},3e3)}catch(r){console.error("复制失败:",r)}}}}},W={class:"container"},Z={class:"main-content"},q={class:"top-nav"},G={class:"top-nav-user"},Q={class:"user-info"},X={class:"user-name"},Y={class:"user-role"},$={class:"messages-container",ref:"messagesContainer"},tt={key:0,class:"messages-start"},et={class:"message-content"},st=["innerHTML"],ot={key:1},nt=["onClick"],at={class:"message-time"},it={key:1,class:"typing-indicator"},rt={class:"input-container"},lt={class:"input-area"},ct=["disabled"],dt={class:"input-actions"},ut={key:0,class:"typing-indicator"},gt={class:"suggestions"},pt=["onClick"];function vt(y,s,a,o,g,m){var c,h;const p=L("ParticlesBackground"),_=L("Sidebar");return u(),d("div",W,[D(p),D(_),e("main",Z,[e("div",q,[s[4]||(s[4]=e("h2",{class:"top-nav-title"},"智能问答",-1)),e("div",G,[s[3]||(s[3]=e("div",{class:"user-avatar"},[e("i",{class:"fas fa-user"})],-1)),e("div",Q,[e("div",X,w(((c=o.user)==null?void 0:c.username)||"管理员"),1),e("div",Y,w(((h=o.user)==null?void 0:h.role)||"系统管理员"),1)])])]),e("div",$,[o.messages.length===0?(u(),d("p",tt,"Hi，今天有什么可以帮到你吗？")):T("",!0),(u(!0),d(H,null,N(o.messages,(n,f)=>(u(),d("div",{key:f,class:V(["message",n.type])},[e("div",et,[n.isStreaming?(u(),d("div",ot,[E(w(n.content),1),s[5]||(s[5]=e("span",{class:"streaming-cursor"},"|",-1))])):(u(),d("div",{key:0,innerHTML:o.formatMessageContent(n.content)},null,8,st)),n.isStreaming?T("",!0):(u(),d("button",{key:2,class:"copy-btn",onClick:C=>o.copyMessage(n.content,f)},[s[6]||(s[6]=e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2",stroke:"currentColor","stroke-width":"2"}),e("path",{d:"M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:V(["copy-tooltip",{show:n.showTooltip}])},w(n.tooltipText||"复制"),3)],8,nt))]),e("div",at,w(n.time),1)],2))),128)),o.typing?(u(),d("div",it,[...s[7]||(s[7]=[e("span",null,"AI正在思考",-1),e("div",{class:"typing-dots"},[e("div",{class:"typing-dot"}),e("div",{class:"typing-dot"}),e("div",{class:"typing-dot"})],-1)])])):T("",!0)],512),e("div",rt,[e("div",lt,[P(e("textarea",{class:"text-input","onUpdate:modelValue":s[0]||(s[0]=n=>o.inputMessage=n),onKeydown:s[1]||(s[1]=(...n)=>o.handleKeyDown&&o.handleKeyDown(...n)),placeholder:"请输入您的问题...",rows:"1"},null,544),[[I,o.inputMessage]]),e("button",{class:"send-btn",onClick:s[2]||(s[2]=(...n)=>o.sendMessage&&o.sendMessage(...n)),disabled:!o.inputMessage.trim()||o.sending},[...s[8]||(s[8]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M22 2L11 13",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M22 2L15 22L11 13L2 9L22 2Z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,ct)]),e("div",dt,[o.typing?(u(),d("div",ut,[...s[9]||(s[9]=[e("span",null,"AI正在思考",-1),e("div",{class:"typing-dots"},[e("div",{class:"typing-dot"}),e("div",{class:"typing-dot"}),e("div",{class:"typing-dot"})],-1)])])):T("",!0),s[10]||(s[10]=e("div",null,"按Enter发送，Shift+Enter换行",-1))]),e("div",gt,[(u(!0),d(H,null,N(o.suggestions,(n,f)=>(u(),d("div",{key:f,class:"suggestion",onClick:C=>o.selectSuggestion(n)},w(n),9,pt))),128))])])])])}const wt=K(U,[["render",vt],["__scopeId","data-v-5ad84020"]]);export{wt as default};
